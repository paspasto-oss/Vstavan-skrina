<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rolldoor Professional – Konfigurátor</title>
  <style>
    :root { --red:#c40000; --bg:#f6f7fb; --card:#fff; --border:#e5e7eb; --text:#111827; --muted:#6b7280; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{max-width:1250px;margin:0 auto;padding:14px 16px 8px}
    h1{margin:0;font-size:18px}
    p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .wrap{max-width:1250px;margin:0 auto;padding:12px 16px 28px}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:12px;align-items:start}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label{display:block;font-size:11px;font-weight:bold;color:var(--muted);margin:0 0 4px;text-transform:uppercase}
    input, select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff}
    button{border:1px solid var(--border);background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700; transition: all 0.2s}
    button.primary{background:var(--red);color:#fff;border-color:var(--red)}
    button.small{padding:6px 8px;border-radius:8px;font-weight:700;font-size:11px}
    button:hover{background:#f3f4f6}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .hr{height:1px;background:var(--border);margin:15px 0}
    
    /* Preview & Table */
    .preview{width:100%;aspect-ratio:16/9;border:1px solid var(--border);border-radius:12px;background:#fafafa;margin-bottom:15px}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--border);font-size:13px;text-align:left}
    th{background:#f9fafb;color:var(--muted);font-size:11px;text-transform:uppercase}
    .mono{font-family:monospace;font-weight:bold;color:var(--red)}
    
    /* Modul Editor */
    .modCard{border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:8px;background:#f9fafb; position: relative;}
    .modActions{display:flex; gap:4px; margin-top:8px;}
    .sectionRow{display:flex;gap:5px;margin-bottom:10px; overflow-x: auto; padding-bottom: 5px;}
    .pill{padding:6px 14px;border-radius:20px;font-size:12px;border:1px solid var(--border);background:#fff;white-space: nowrap;}
    .pill.active{background:var(--red);color:#fff;border-color:var(--red)}

    @media print {
      .grid{display:block}
      .card:first-child, .btns, .hr, .sectionRow, button{display:none}
      body{background:#fff}
      .card{border:none}
    }
  </style>
</head>
<body>

<header>
  <h1>Rolldoor Pro – Výroba a porezové plány</h1>
  <p>Konfigurácia vnútornej vstavanej skrine s automatickým výpočtom hliníkových profilov a kovaní.</p>
</header>

<div class="wrap grid">
  <section class="card">
    <div class="row3">
      <div><label>Šírka (W)</label><input id="W" type="number" value="2400"></div>
      <div><label>Výška (H)</label><input id="H" type="number" value="2600"></div>
      <div><label>Hĺbka (D)</label><input id="D" type="number" value="600"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div><label>Hrúbka DTD (t)</label><input id="t" type="number" value="18"></div>
      <div><label>Odsadenie políc</label><input id="setback" type="number" value="80"></div>
    </div>
    <div class="hr"></div>
    <div class="row">
      <div><label>Počet sekcií</label><input id="sections" type="number" value="3"></div>
      <div><label>Počet krídel</label><input id="doors" type="number" value="3"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div><label>Vôľa výška (mm)</label><input id="gapHeightTotal" type="number" value="40"></div>
      <div><label>Prekrytie (mm)</label><input id="overlap" type="number" value="30"></div>
    </div>
    <div class="hr"></div>
    <div class="row">
      <div>
        <label>Korpusy zásuviek</label>
        <select id="drawerBoxes">
          <option value="no">Nie (iba čelá)</option>
          <option value="yes" selected>Áno (komplet)</option>
        </select>
      </div>
      <div><label>Vôľa výsuvov</label><input id="drawerSideGap" type="number" value="12.5"></div>
    </div>

    <div class="btns">
      <button class="primary" onclick="initSections()">Prepočítať sekcie</button>
      <button onclick="generateCutList()">Aktualizovať porez</button>
      <button onclick="exportCSV()">Exportovať CSV</button>
    </div>
  </section>

  <section class="card">
    <div id="sectionPills" class="sectionRow"></div>
    <div id="editorPanel" style="margin-bottom:15px">
       <div class="btns" style="margin-bottom:12px; background: #eee; padding: 8px; border-radius: 12px;">
         <span style="font-size: 11px; font-weight: bold; width: 100%; display: block; margin-bottom: 5px;">PRIDAŤ MODUL:</span>
         <button class="small" onclick="addModule('shelf')">+ Polica</button>
         <button class="small" onclick="addModule('drawers')">+ Zásuvky</button>
         <button class="small" onclick="addModule('rod')">+ Šatníková tyč</button>
         <button class="small" onclick="addModule('free')">Prázdny priestor</button>
       </div>
       <div id="modulesContainer"></div>
    </div>

    <div class="preview" id="preview"></div>

    <table>
      <thead>
        <tr>
          <th>Názov dielca</th>
          <th>Materiál</th>
          <th>Rozmer (mm)</th>
          <th>Ks</th>
          <th>Poznámka</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>
</div>

<script>
  let state = {
    sections: [],
    active: 0
  };

  const el = (id) => document.getElementById(id);
  const getVal = (id) => Number(el(id).value);

  function initSections() {
    const W = getVal("W"), t = getVal("t"), n = Math.max(1, getVal("sections"));
    const innerW = W - (2 * t);
    const secW = (innerW - (n - 1) * t) / n;
    
    state.sections = Array.from({length: n}, () => ({
      width: secW,
      modules: [{type: "free", height: 300}]
    }));
    state.active = 0;
    renderAll();
  }

  function addModule(type) {
    const m = { 
        type, 
        height: type === 'drawers' ? 600 : (type === 'rod' ? 100 : 200), 
        count: 3, 
        id: Date.now() 
    };
    state.sections[state.active].modules.push(m);
    renderAll();
  }

  // Funkcie na posúvanie modulov
  function moveMod(idx, direction) {
    const mods = state.sections[state.active].modules;
    if (direction === 'up' && idx > 0) {
        [mods[idx], mods[idx-1]] = [mods[idx-1], mods[idx]];
    } else if (direction === 'down' && idx < mods.length - 1) {
        [mods[idx], mods[idx+1]] = [mods[idx+1], mods[idx]];
    }
    renderAll();
  }

  function moveToSection(idx, targetDir) {
    const targetSecIdx = state.active + targetDir;
    if (targetSecIdx >= 0 && targetSecIdx < state.sections.length) {
        const mod = state.sections[state.active].modules.splice(idx, 1)[0];
        state.sections[targetSecIdx].modules.push(mod);
        renderAll();
    }
  }

  function renderAll() {
    renderPills();
    renderEditor();
    renderPreview();
    saveToLocal();
  }

  function renderPills() {
    const cont = el("sectionPills");
    cont.innerHTML = "";
    state.sections.forEach((s, i) => {
      const b = document.createElement("button");
      b.className = `pill ${i === state.active ? 'active' : ''}`;
      b.textContent = `Sekcia ${i+1} (${Math.round(s.width)}mm)`;
      b.onclick = () => { state.active = i; renderAll(); };
      cont.appendChild(b);
    });
  }

  function renderEditor() {
    const cont = el("modulesContainer");
    cont.innerHTML = "";
    const sec = state.sections[state.active];
    if (!sec) return;

    sec.modules.forEach((m, idx) => {
      const div = document.createElement("div");
      div.className = "modCard";
      const nazov = {shelf:'POLICA', drawers:'ZÁSUVKY', rod:'ŠATNÍKOVÁ TYČ', free:'PRÁZDNY PRIESTOR'}[m.type];
      
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center">
          <strong style="font-size:12px; color:var(--red)">${nazov}</strong>
          <div>
            <button class="small" onclick="moveMod(${idx}, 'up')">↑</button>
            <button class="small" onclick="moveMod(${idx}, 'down')">↓</button>
            <button class="small" onclick="removeModule(${idx})">✕</button>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div><label>Svetlá výška (mm)</label><input type="number" value="${m.height}" onchange="updateMod(${idx}, 'height', this.value)"></div>
          ${m.type === 'drawers' ? `<div><label>Počet šuplíkov</label><input type="number" value="${m.count}" onchange="updateMod(${idx}, 'count', this.value)"></div>` : ''}
        </div>
        <div class="modActions">
          <span style="font-size:10px; color:var(--muted); margin-right:5px">PRESUNÚŤ DO:</span>
          <button class="small" onclick="moveToSection(${idx}, -1)" ${state.active === 0 ? 'disabled' : ''}>← Sekcie</button>
          <button class="small" onclick="moveToSection(${idx}, 1)" ${state.active === state.sections.length-1 ? 'disabled' : ''}>Sekcie →</button>
        </div>
      `;
      cont.appendChild(div);
    });
  }

  function removeModule(idx) {
    state.sections[state.active].modules.splice(idx, 1);
    renderAll();
  }

  function updateMod(idx, field, val) {
    state.sections[state.active].modules[idx][field] = Number(val);
    renderPreview();
    saveToLocal();
  }

  function addPart(parts, name, material, a, b, qty, note="") {
    if (a <= 0 || b <= 0) return;
    parts.push({name, material, a: Math.round(a), b: Math.round(b), qty, note});
  }

  function generateCutList() {
    const W = getVal("W"), H = getVal("H"), D = getVal("D"), t = getVal("t");
    const setback = getVal("setback"), dCount = getVal("doors"), overlap = getVal("overlap");
    const parts = [];

    // 1. Konštrukčné lišty (Dorazy)
    addPart(parts, "Dorazová lišta zvislá", "DTD", H, 100, 2, "Montáž na stenu");
    addPart(parts, "Dorazová lišta vodorovná", "DTD", W - 200, 100, 2, "Strop a podlaha");

    // 2. Vonkajší korpus
    addPart(parts, "Bok skrine vonkajší", "DTD", H, D, 2, "Hlavné stojky");
    addPart(parts, "Pôda / Dno", "DTD", W - (2*t), D, 2);
    addPart(parts, "Chrbát (sololit)", "HDF", H-5, W-5, 1, "Biela / Dekor");

    // 3. Vnútorné delenie
    state.sections.forEach((sec, sIdx) => {
      if (sIdx < state.sections.length - 1) {
        addPart(parts, "Vnútorná priečka (stojka)", "DTD", H-(2*t), D-setback, 1, `Medzi sekciou ${sIdx+1}/${sIdx+2}`);
      }
      
      sec.modules.forEach(m => {
        if (m.type === "shelf") {
          addPart(parts, "Polica pevná", "DTD", sec.width, D-setback, 1, `Sekcia ${sIdx+1}`);
        }
        if (m.type === "drawers" && el("drawerBoxes").value === "yes") {
            const innerBoxW = sec.width - (2 * getVal("drawerSideGap"));
            const boxH = (m.height / m.count) - 30;
            addPart(parts, "Zásuvka - bok", "DTD", D-setback-20, boxH, m.count*2, `Sekcia ${sIdx+1}`);
            addPart(parts, "Zásuvka - čelo/zad", "DTD", innerBoxW - (2*t), boxH, m.count*2, `Sekcia ${sIdx+1}`);
            addPart(parts, "Zásuvka - dno (sololit)", "HDF", innerBoxW - 5, D-setback-25, m.count, `Sekcia ${sIdx+1}`);
            addPart(parts, "Zásuvka - viditeľné čelo", "DTD", sec.width - 4, (m.height/m.count)-4, m.count, `Sekcia ${sIdx+1}`);
        }
        if (m.type === "rod") {
          addPart(parts, "Šatníková tyč (kov)", "Kov", sec.width - 4, 0, 1, `Sekcia ${sIdx+1}`);
        }
      });
    });

    // 4. Posuvné dvere - Hliníkový systém
    const wingW = (W - (2*t) + (dCount-1)*overlap) / dCount;
    const wingH = H - (2*t) - getVal("gapHeightTotal");
    addPart(parts, "Dvere - výplň (DTD 10mm)", "DTD", wingH - 38, wingW - 50, dCount, "Pre hliníkový rám");

    renderTable(parts);
    saveToLocal();
  }

  function renderTable(parts) {
    const tb = el("tbody");
    tb.innerHTML = "";
    parts.forEach(p => {
      tb.innerHTML += `<tr><td>${p.name}</td><td>${p.material}</td><td class="mono">${p.a} x ${p.b}</td><td>${p.qty}</td><td>${p.note}</td></tr>`;
    });
  }

  function renderPreview() {
    const W = getVal("W"), H = getVal("H"), t = getVal("t");
    const container = el("preview");
    if(!container) return;
    
    let svg = `<svg width="100%" height="100%" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">`;
    svg += `<rect x="0" y="0" width="${W}" height="${H}" fill="#fff" stroke="#333" stroke-width="10"/>`;
    
    let curX = t;
    state.sections.forEach(sec => {
        svg += `<line x1="${curX}" y1="0" x2="${curX}" y2="${H}" stroke="#333" stroke-width="5"/>`;
        let curY = t;
        sec.modules.forEach(m => {
            if (m.type !== 'free') {
                let col = m.type==='shelf'?'#ddd':(m.type==='drawers'?'#fde68a':'#93c5fd');
                svg += `<rect x="${curX+2}" y="${curY}" width="${sec.width-4}" height="${m.height}" fill="${col}" stroke="#999" fill-opacity="0.6"/>`;
            }
            curY += m.height;
        });
        curX += sec.width + t;
    });
    svg += `</svg>`;
    container.innerHTML = svg;
  }

  function saveToLocal() {
    const data = { 
        state, 
        inputs: { 
            W: el("W").value, 
            H: el("H").value, 
            D: el("D").value,
            t: el("t").value,
            sections: el("sections").value, 
            doors: el("doors").value,
            setback: el("setback").value
        }
    };
    localStorage.setItem("rolldoor_db_v2", JSON.stringify(data));
  }

  window.onload = () => {
    const saved = localStorage.getItem("rolldoor_db_v2");
    if (saved) {
        const d = JSON.parse(saved);
        state = d.state;
        Object.keys(d.inputs).forEach(k => { if(el(k)) el(k).value = d.inputs[k]; });
        renderAll();
    } else {
        initSections();
    }
  };

  function exportCSV() {
    const rows = [["Nazov", "Material", "Rozmer A", "Rozmer B", "Ks", "Poznamka"]];
    const tbody = el("tbody");
    for (let tr of tbody.rows) {
        let row = [];
        for (let td of tr.cells) row.push(td.innerText);
        rows.push(row);
    }
    let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
    let encodedUri = encodeURI(csvContent);
    let link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "narezovy_plan.csv");
    document.body.appendChild(link);
    link.click();
  }
</script>

</body>
</html>
